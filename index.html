<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Grand Theft Racer: Physics Overhaul</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path d='M10 50 L20 30 L80 30 L90 50 L90 70 L10 70 Z' fill='crimson' stroke='white' stroke-width='3'/><rect x='40' y='10' width='20' height='20' fill='gold'/></svg>">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;900&display=swap');

        body {
            margin: 0; overflow: hidden; background: #000;
            font-family: 'Orbitron', sans-serif; color: white;
            user-select: none; touch-action: none;
        }

        #game-container {
            position: relative; width: 100vw; height: 100vh;
            display: flex; justify-content: center; align-items: center; background: #111;
        }

        canvas {
            box-shadow: 0 0 80px rgba(0,0,0,0.8); 
            border-left: 5px solid #222; border-right: 5px solid #222;
            background: #050505; max-width: 100%; max-height: 100%; z-index: 5;
        }

        /* --- VISUALS --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 20; transition: opacity 0.3s;
            background: linear-gradient(to bottom, #200f21 0%, #381534 50%, #0d0d0d 50%, #111 100%);
        }
        
        .screen::after {
            content: ''; position: absolute; top: 10%; width: 200px; height: 200px;
            background: linear-gradient(to bottom, #f9b006, #e74c3c);
            border-radius: 50%; z-index: -1; box-shadow: 0 0 50px #e74c3c;
        }

        .hidden { opacity: 0; pointer-events: none; z-index: -1; }

        h1 { 
            color: #f9b006; font-size: 3rem; text-transform: uppercase; margin-bottom: 20px;
            text-shadow: 4px 4px 0 #000; letter-spacing: 5px;
            background: rgba(0,0,0,0.6); padding: 10px 20px; border: 2px solid #f9b006;
        }

        /* HUD */
        #top-hud {
            position: absolute; top: 10px; left: 10px; right: 10px;
            display: none; justify-content: space-between; pointer-events: none; z-index: 15;
            text-shadow: 1px 1px 0 #000;
        }
        .hud-box { background: rgba(0,0,0,0.8); padding: 5px 15px; border-radius: 4px; border: 1px solid #444; min-width: 80px; text-align: center; }
        .bar-wrap { width: 120px; height: 8px; background: #333; margin-top: 5px; transform: skewX(-20deg); border: 1px solid #fff; }
        .bar-fill { height: 100%; width: 100%; transition: width 0.1s; }

        /* CARDS */
        .selection-grid { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; z-index: 2; }
        .card {
            background: linear-gradient(145deg, #1a1a1a, #000); border: 2px solid #444; padding: 20px; width: 160px;
            text-align: center; cursor: pointer; transition: 0.2s; margin: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .card:hover { border-color: #f9b006; transform: translateY(-5px) scale(1.05); background: #222; }

        /* SETTINGS & MODALS */
        #settings-btn {
            position: absolute; top: 90px; right: 20px; font-size: 24px; cursor: pointer; z-index: 101;
            color: #fff; background: rgba(0,0,0,0.7); padding: 10px; border: 2px solid #555; border-radius: 5px;
        }
        #settings-modal {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 102; justify-content: center; align-items: center;
        }
        .pause-box {
            background: #111; border: 2px solid #f9b006; padding: 30px; width: 300px; text-align: center;
            box-shadow: 0 0 30px rgba(249, 176, 6, 0.2);
        }
        .btn-opt {
            width: 100%; padding: 12px; margin-bottom: 10px; background: #333; color: #fff;
            border: 1px solid #777; font-family: 'Orbitron', sans-serif; cursor: pointer; font-size: 14px;
        }
        .btn-opt:hover { background: #fff; color: #000; }

        /* MOBILE CONTROLS */
        #mobile-controls {
            position: absolute; bottom: 20px; left: 0; width: 100%; height: 160px;
            display: none; pointer-events: none; z-index: 30;
        }
        .m-btn {
            position: absolute; width: 70px; height: 70px;
            background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%; pointer-events: auto; display: flex; justify-content: center; align-items: center;
            font-size: 24px; color: #fff; backdrop-filter: blur(2px);
        }
        .m-btn:active { background: rgba(255,255,255,0.3); transform: scale(0.95); }

        #wasted-screen { background: rgba(180, 0, 0, 0.9); display: none; z-index: 100; }
        #busted-text {
            font-size: 5rem; color: #fff; background: #2980b9; padding: 10px 50px;
            transform: rotate(-3deg); border: 5px solid #fff; text-shadow: 5px 5px 0 #000;
            box-shadow: 10px 10px 20px rgba(0,0,0,0.5);
        }
        #ammo-count { color: #f1c40f; font-size: 20px; font-weight: bold; }
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
    </style>
</head>
<body>

<div id="settings-btn" onclick="Game.toggleSettings()">‚öôÔ∏è</div>

<div id="settings-modal">
    <div class="pause-box">
        <h2 style="color:#fff; margin-top:0;">PAUSED</h2>
        <button class="btn-opt" onclick="Game.toggleSound()" id="btn-sound">SOUND: ON</button>
        <button class="btn-opt" onclick="Game.toggleTouch()" id="btn-touch">TOUCH: OFF</button>
        <hr style="border-color:#444; margin:15px 0;">
        <button class="btn-opt" style="border-color:#2ecc71; color:#2ecc71" onclick="Game.toggleSettings()">RESUME</button>
        <button class="btn-opt" style="border-color:#e74c3c; color:#e74c3c" onclick="location.reload()">EXIT TO MENU</button>
    </div>
</div>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <div id="top-hud">
        <div class="hud-box">
            <div style="font-size:10px; color:#aaa">ARMOR</div>
            <div class="bar-wrap"><div id="hp-bar" class="bar-fill" style="background:#e74c3c"></div></div>
        </div>
        <div class="hud-box">
            <div style="font-size:10px; color:#aaa">AMMO</div>
            <div id="ammo-count">60</div>
        </div>
        <div class="hud-box">
            <div style="font-size:10px; color:#aaa">CASH</div>
            <div style="font-size:20px; color:#2ecc71">$<span id="score-val">0</span></div>
        </div>
        <div class="hud-box" style="text-align:right">
            <div style="font-size:10px; color:#aaa">NITRO</div>
            <div class="bar-wrap"><div id="nitro-bar" class="bar-fill" style="background:#3498db"></div></div>
        </div>
    </div>

    <div id="screen-theme" class="screen">
        <h1>Grand Theft Racer</h1>
        <div class="selection-grid">
            <div class="card" onclick="Game.setTheme('metro')">
                <div class="card-icon" style="color:#00f3ff">üåÉ</div>METRO
            </div>
            <div class="card" onclick="Game.setTheme('desert')">
                <div class="card-icon" style="color:#e67e22">üèúÔ∏è</div>DESERT
            </div>
            <div class="card" onclick="Game.setTheme('jungle')">
                <div class="card-icon" style="color:#2ecc71">üå≤</div>JUNGLE
            </div>
        </div>
    </div>

    <div id="screen-car" class="screen hidden">
        <h1>Select Vehicle</h1>
        <div class="selection-grid">
            <div class="card" onclick="Game.setCar('racer')">
                <div class="card-icon" style="color:#e74c3c">üèéÔ∏è</div>SPEEDSTER
                <div style="font-size:10px; color:#aaa; margin-top:5px">Fast & Agile</div>
            </div>
            <div class="card" onclick="Game.setCar('tank')">
                <div class="card-icon" style="color:#27ae60">üöô</div>ENFORCER
                <div style="font-size:10px; color:#aaa; margin-top:5px">Heavy & Tough</div>
            </div>
        </div>
    </div>

    <div id="wasted-screen" class="screen">
        <div id="busted-text">WASTED</div>
        <p style="font-size: 24px; color:#fff; margin-top:20px">STOLEN: $<span id="final-score">0</span></p>
        <p class="blink" style="margin-top: 30px; color: #f9b006;">PRESS [SPACE] TO RESPAWN</p>
    </div>

    <div id="mobile-controls">
        <div class="m-btn" id="m-left" style="bottom: 20px; left: 20px;">‚Üê</div>
        <div class="m-btn" id="m-right" style="bottom: 20px; left: 100px;">‚Üí</div>
        <div class="m-btn" id="m-nitro" style="bottom: 20px; right: 20px; border-color:#3498db;">N</div>
        <div class="m-btn" id="m-fire" style="bottom: 100px; right: 20px; border-color:#e74c3c;">F</div>
    </div>
</div>

<script>
const AudioSys = {
    ctx: null, enabled: true,
    init() { if(!this.ctx) this.ctx = new (window.AudioContext||window.webkitAudioContext)(); },
    play(type) {
        if(!this.enabled || !this.ctx) return;
        if(this.ctx.state === 'suspended') this.ctx.resume();
        const t = this.ctx.currentTime;
        const o = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        o.connect(g); g.connect(this.ctx.destination);

        if(type==='shoot'){ o.type='square'; o.frequency.setValueAtTime(400,t); g.gain.setValueAtTime(0.1,t); o.start(t); o.stop(t+0.1); }
        else if(type==='nitro'){ o.type='sawtooth'; o.frequency.linearRampToValueAtTime(300,t+0.5); g.gain.setValueAtTime(0.15,t); o.start(t); o.stop(t+0.5); }
        else if(type==='crash'){ o.type='sawtooth'; o.frequency.exponentialRampToValueAtTime(10,t+0.3); g.gain.setValueAtTime(0.3,t); o.start(t); o.stop(t+0.3); }
        else if(type==='coin'){ o.type='sine'; o.frequency.setValueAtTime(1200,t); o.frequency.linearRampToValueAtTime(2000,t+0.1); g.gain.setValueAtTime(0.1,t); o.start(t); o.stop(t+0.1); }
        else if(type==='busted'){ o.type='triangle'; o.frequency.setValueAtTime(100,t); o.frequency.linearRampToValueAtTime(50,t+1); g.gain.setValueAtTime(0.5,t); o.start(t); o.stop(t+1); }
        else if(type==='heli'){ o.type='square'; o.frequency.setValueAtTime(60,t); g.gain.setValueAtTime(0.1,t); o.start(t); o.stop(t+0.15); } 
        else if(type==='warn'){ o.type='sine'; o.frequency.setValueAtTime(800,t); g.gain.setValueAtTime(0.1,t); o.start(t); o.stop(t+0.1); } 
        else if(type==='smash'){ o.type='square'; o.frequency.setValueAtTime(50,t); g.gain.setValueAtTime(0.2,t); o.start(t); o.stop(t+0.1); } 
    }
};

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const GW = 800, GH = 600;
function resize(){ canvas.width=GW; canvas.height=GH; }
resize();

const THEMES = {
    metro: { road: '#222', grass: '#151515', lane: '#00f3ff', decor: 'build', density: 0.05 },
    desert: { road: '#654', grass: '#cba', lane: '#fff', decor: 'cactus', density: 0.03 },
    jungle: { road: '#555', grass: '#282', lane: '#fff', decor: 'tree', density: 0.08 }
};
const CARS = {
    racer: { color: '#e74c3c', speed: 12, hp: 60, w: 40, h: 70, mass: 1 },
    tank: { color: '#27ae60', speed: 9, hp: 150, w: 50, h: 80, mass: 2 }
};

const Input = { left:false, right:false, up:false, fire:false };
window.addEventListener('keydown', e => {
    AudioSys.init();
    if(Game.state==='GAMEOVER' && e.code==='Space') Game.restart();
    if(e.key==='ArrowLeft') Input.left=true;
    if(e.key==='ArrowRight') Input.right=true;
    if(e.key==='Shift') Input.up=true;
    if(e.code==='Space'||e.key==='f') Input.fire=true;
    if(e.key==='Escape') Game.toggleSettings();
});
window.addEventListener('keyup', e => {
    if(e.key==='ArrowLeft') Input.left=false;
    if(e.key==='ArrowRight') Input.right=false;
    if(e.key==='Shift') Input.up=false;
    if(e.code==='Space'||e.key==='f') Input.fire=false;
});
const bindTouch=(id,k)=>{ 
    const el = document.getElementById(id);
    el.addEventListener('touchstart',e=>{e.preventDefault();Input[k]=true;AudioSys.init();}); 
    el.addEventListener('touchend',e=>{e.preventDefault();Input[k]=false;}); 
};
bindTouch('m-left','left'); bindTouch('m-right','right'); bindTouch('m-nitro','up'); bindTouch('m-fire','fire');

const Artist = {
    drawCar(ctx, x, y, type, color, w, h, hp) {
        if(isNaN(x) || isNaN(y)) return; 
        ctx.save(); ctx.translate(x, y);
        
        // Shadow
        ctx.fillStyle='rgba(0,0,0,0.5)'; ctx.fillRect(-w/2+5, -h/2+5, w, h);

        if(type==='police') {
             const blink = Date.now()%300 < 150;
             if(blink) {
                 ctx.globalCompositeOperation = 'lighter';
                 ctx.fillStyle='rgba(255,0,0,0.3)'; ctx.beginPath(); ctx.moveTo(0, -h/2); ctx.arc(0, -h/2, 200, -Math.PI*0.7, -Math.PI*0.3); ctx.fill();
                 ctx.fillStyle='rgba(0,0,255,0.3)'; ctx.beginPath(); ctx.moveTo(0, -h/2); ctx.arc(0, -h/2, 200, -Math.PI*0.7, -Math.PI*0.3); ctx.fill();
                 ctx.globalCompositeOperation = 'source-over';
             }
        }

        ctx.fillStyle = color; if(type==='police') ctx.fillStyle='#fff';
        ctx.beginPath(); ctx.roundRect(-w/2, -h/2, w, h, 4); ctx.fill();
        
        // Damage Visual
        if(hp < 20) { ctx.fillStyle = 'rgba(50,50,50,0.6)'; ctx.beginPath(); ctx.arc(0, 0, 15, 0, Math.PI*2); ctx.fill(); }

        ctx.fillStyle='#111'; ctx.fillRect(-w/2+4,-h/2+15,w-8,15); ctx.fillRect(-w/2+4,h/2-25,w-8,10);
        ctx.fillStyle='#fff'; ctx.fillRect(-w/2+2,-h/2,8,4); ctx.fillRect(w/2-10,-h/2,8,4);
        
        if(type==='police'){ 
            ctx.fillStyle='#111'; ctx.fillRect(-w/2,-10,w,25);
            ctx.fillStyle=Date.now()%200>100?'#f00':'#00f'; ctx.fillRect(-10,-6,20,6);
        }
        ctx.restore();
    },
    drawExhaust(ctx, x, y, w) {
        // Nitro Flames
        ctx.save(); ctx.translate(x, y + 35);
        let flicker = Math.random() * 20;
        ctx.fillStyle = Math.random()>0.5 ? '#f39c12' : '#e74c3c';
        ctx.beginPath(); ctx.moveTo(-10, 0); ctx.lineTo(-10, flicker); ctx.lineTo(-15, 0); ctx.fill();
        ctx.beginPath(); ctx.moveTo(10, 0); ctx.lineTo(10, flicker); ctx.lineTo(15, 0); ctx.fill();
        ctx.restore();
    },
    drawPed(ctx, x, y, shirtColor) {
        ctx.save(); ctx.translate(x, y);
        let leg = Math.sin(Date.now()/50)*5;
        ctx.strokeStyle = '#333'; ctx.lineWidth=3;
        ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(-3, 10+leg); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(3, 10-leg); ctx.stroke();
        ctx.fillStyle = shirtColor; ctx.fillRect(-5, -5, 10, 12);
        ctx.fillStyle = '#ffdbac'; ctx.beginPath(); ctx.arc(0, -8, 5, 0, Math.PI*2); ctx.fill();
        ctx.restore();
    },
    drawHeli(ctx, x, y, hp) {
        ctx.save(); ctx.translate(x, y);
        ctx.fillStyle='rgba(0,0,0,0.3)'; ctx.beginPath(); ctx.ellipse(-20, 150, 60, 20, 0, 0, Math.PI*2); ctx.fill(); 
        ctx.fillStyle='rgba(0,0,0,0.5)'; ctx.beginPath(); ctx.ellipse(0, 0, 100, 8, Date.now()/30, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle='#333'; ctx.beginPath(); ctx.ellipse(0, 0, 25, 60, 0, 0, Math.PI*2); ctx.fill(); 
        ctx.fillStyle='#f00'; ctx.fillRect(-25, -70, 50, 5); ctx.fillStyle='#0f0'; ctx.fillRect(-25, -70, (hp/30)*50, 5); 
        ctx.restore();
    },
    drawBillboard(ctx, s) {
        ctx.save(); ctx.translate(s.x, s.y);
        
        // Physics Rotation for Crashed Signs
        if(s.crashed) {
            ctx.rotate(s.angle || 0);
            ctx.globalAlpha = 0.7;
        }

        ctx.fillStyle = '#555'; ctx.fillRect(-2, 0, 4, 60); 
        ctx.fillStyle = '#333'; ctx.fillRect(-40, -40, 80, 40); 
        ctx.fillStyle = '#fff'; ctx.fillRect(-35, -35, 70, 30); 
        ctx.fillStyle = '#000'; ctx.font = '10px Arial'; ctx.textAlign = 'center';
        const slogans = ["OBEY", "BUY", "SPEED", "RACE"];
        const text = slogans[Math.floor(s.x % slogans.length)]; 
        ctx.fillText(text, 0, -15);
        ctx.restore();
    },
    drawAmmo(ctx, x, y) {
        ctx.save(); ctx.translate(x, y);
        ctx.fillStyle='#f1c40f'; ctx.fillRect(-10, -10, 20, 20); 
        ctx.fillStyle='#000'; ctx.font='bold 14px Arial'; ctx.textAlign='center';
        ctx.fillText('A', 0, 5);
        ctx.restore();
    },
    drawBundle(ctx, x, y) {
        ctx.save(); ctx.translate(x, y);
        ctx.fillStyle='#27ae60'; ctx.fillRect(-12, -6, 24, 12); 
        ctx.fillStyle='#2ecc71'; ctx.fillRect(-3, -6, 6, 12);
        ctx.fillStyle='#fff'; ctx.font='10px Arial'; ctx.textAlign='center';
        ctx.fillText('$', 0, 4);
        ctx.restore();
    }
};

const Game = {
    state: 'MENU', paused: false, theme: null, car: null,
    player: { x:400, y:500, hp:100, maxHp:100, nitro:100, speed:0, w:40, h:70, ammo:60, mass: 1 },
    score: 0, roadOffset: 0, crimeLevel: 0, policeKilled: 0, lastTime: 0,
    heli: { active:false, x:400, y:-150, hp:30, timer:0 },
    entities: [], bullets: [], scenery: [], particles: [], envObjects: [], texts: [],

    setTheme(n){ this.theme=THEMES[n]; document.getElementById('screen-theme').classList.add('hidden'); document.getElementById('screen-car').classList.remove('hidden'); },
    setCar(n){ this.car=CARS[n]; this.restart(); },
    
    init() {
        let snd = localStorage.getItem('gtr_sound');
        let tch = localStorage.getItem('gtr_touch');
        if(snd === 'off') { AudioSys.enabled=false; document.getElementById('btn-sound').innerText='SOUND: OFF'; }
        if(tch === 'on') { document.getElementById('btn-touch').innerText='TOUCH: ON'; document.getElementById('mobile-controls').style.display='block'; }
        this.lastTime = performance.now();
        requestAnimationFrame(t => this.loop(t));
    },

    restart(){
        this.state='PLAYING'; this.paused=false;
        Object.assign(this.player, { hp:this.car.hp, maxHp:this.car.hp, nitro:100, speed:0, x:400, ammo:60, mass: this.car.mass });
        this.score=0; this.policeKilled=0; this.crimeLevel=0;
        this.heli = { active:false, x:400, y:-150, hp:30, timer:0 };
        this.entities=[]; this.bullets=[]; this.scenery=[]; this.particles=[]; this.envObjects=[]; this.texts=[];
        document.getElementById('screen-car').classList.add('hidden');
        document.getElementById('wasted-screen').style.display='none';
        document.getElementById('top-hud').style.display='flex';
    },

    toggleSettings(){
        const m = document.getElementById('settings-modal');
        if(m.style.display === 'flex') {
            m.style.display = 'none';
            if(this.state === 'PAUSED') { this.state = 'PLAYING'; this.paused = false; }
        } else {
            m.style.display = 'flex';
            if(this.state === 'PLAYING') { this.state = 'PAUSED'; this.paused = true; }
        }
    },
    toggleSound(){ AudioSys.enabled = !AudioSys.enabled; localStorage.setItem('gtr_sound', AudioSys.enabled?'on':'off'); document.getElementById('btn-sound').innerText='SOUND: '+(AudioSys.enabled?'ON':'OFF'); },
    toggleTouch(){ let t = document.getElementById('mobile-controls').style.display === 'none'; localStorage.setItem('gtr_touch', t?'on':'off'); document.getElementById('mobile-controls').style.display = t?'block':'none'; document.getElementById('btn-touch').innerText='TOUCH: '+(t?'ON':'OFF'); },

    spawnText(str, x, y, color) { this.texts.push({str, x, y, color:color||'#fff', life:1.0}); },

    update(dt) {
        if(this.paused) return;
        const p = this.player;

        // Anti-Vanish Check
        if(isNaN(p.x)) p.x = 400;
        if(isNaN(p.speed)) p.speed = 0;

        // CONTROLS 
        if(Input.left) p.x -= 300 * dt; if(Input.right) p.x += 300 * dt;
        p.x = Math.max(35, Math.min(765, p.x)); // Boundary

        let targetSpeed = 4; 
        if(Input.up && p.nitro > 0) { 
            targetSpeed = 22; 
            p.nitro -= 25 * dt; 
            if(Math.random()<0.1) AudioSys.play('nitro'); 
            // NITRO EFFECTS: Smoke and Fire
            this.spawnPart(p.x-10, p.y+40, '#f1c40f', 1);
            this.spawnPart(p.x+10, p.y+40, '#f1c40f', 1);
            if(Math.random()<0.3) this.spawnPart(p.x, p.y+40, '#aaa', 1);
        } 
        else { if(p.nitro<100) p.nitro += 5 * dt; }
        
        p.speed += (targetSpeed - p.speed) * 2 * dt;
        
        // SYNC: Everything moves by moveDist
        let moveDist = p.speed * 50 * dt;
        this.roadOffset = (this.roadOffset + moveDist * 2) % 100;

        // HELICOPTER LOGIC (Simplified)
        if(this.policeKilled >= 4 && !this.heli.active) { this.heli.active=true; this.heli.hp=30; this.spawnText("CHOPPER INBOUND!", 400, 300, 'red'); }
        if(this.heli.active) {
            let dx = p.x - this.heli.x; this.heli.x += dx * 2 * dt; this.heli.y = 120 + Math.sin(Date.now()/500)*20;
            if(Math.random()<0.05) AudioSys.play('heli');
            this.heli.timer += dt;
            if(this.heli.timer > 3) {
                 this.entities.push({x:this.heli.x, y:this.heli.y, type:'missile', speed: p.speed+12, w:10, h:20, targetX: p.x});
                 this.heli.timer = 0;
            }
        }

        // SPAWNING - SCENERY
        if(Math.random() < 2 * dt) { 
            let side = Math.random()>0.5; let dx = side ? Math.random()*150 : 650+Math.random()*150; 
            let type = this.theme.decor;
            // 20% Chance for Crashable Billboard, Place closer to road edge (approx 190 or 610)
            if(Math.random() < 0.2) {
                type = 'billboard';
                dx = side ? 160 + Math.random()*20 : 620 + Math.random()*20;
            }
            this.scenery.push({x:dx, y:-50, type:type, crashed: false, angle: 0, w: 40, h: 10});
        }
        if(Math.random() < 0.5 * dt) this.envObjects.push({y:-50, type:'zebra'});
        
        // SPAWNING - TRAFFIC & ITEMS
        if(Math.random() < 1 * dt) {
            // ITEMS strictly on road (220 to 580)
            let itemX = 230 + Math.random() * 340;
            let carX = 220 + Math.random() * 360;

            if(!this.entities.some(e=>Math.abs(e.x-carX)<60 && Math.abs(e.y+100)<100)) {
                let r = Math.random();
                if(r < 0.05) {
                    this.entities.push({x:itemX, y:-100, type:'ammo', speed:0, w:30, h:30, hp:1, vx:0});
                } else if(r < 0.1) {
                    this.entities.push({x:itemX, y:-100, type:'bundle', speed:0, w:30, h:30, hp:1, vx:0});
                } else {
                    let type = (this.crimeLevel > 0 && Math.random() < 0.4) ? 'police' : 'civ';
                    let spd = type==='police' ? 7 : 3;
                    let mass = type==='police' ? 2 : 1; 
                    this.entities.push({
                        x: carX, y: -100, type, speed: spd, 
                        hp: (type==='police'?50:20), w:40, h:70, vx:0, mass: mass,
                        color: type==='police'?'#fff':`hsl(${Math.random()*360},70%,50%)`
                    });
                }
            }
        }
        
        // SPAWNING - PEDS
        if(Math.random() < 1 * dt) {
            let isZebra = this.envObjects.some(e => e.type === 'zebra' && e.y < 100 && e.y > -50);
            let spawnType = isZebra ? 'cross' : 'walk';
            let skin = ['#e74c3c', '#3498db', '#2ecc71', '#9b59b6', '#f1c40f'][Math.floor(Math.random()*5)];
            let px = Math.random()>0.5 ? 150 : 650;
            if(spawnType === 'walk') this.entities.push({x:px, y:-50, type:'ped', speed:1, w:15, h:15, hp:1, vx:0, vy: 1, shirt:skin});
            else if (spawnType === 'cross') {
                let startX = (px < 400) ? 190 : 610;
                this.entities.push({x:startX, y:-50, type:'ped', speed:1, w:15, h:15, hp:1, vx:(startX<400?50:-50), vy:0, shirt:skin});
            }
            if(Math.random() < 0.05) this.entities.push({x:px, y:-50, type:'ped_cop', speed:1, w:15, h:15, hp:1, vx:0, vy:Math.random()>0.5?0:1, shirt:'#11f'});
        }

        // SHOOTING
        if(Input.fire && p.ammo > 0 && Math.floor(Date.now()/100)%2===0) {
            this.bullets.push({x:p.x-15, y:p.y-20}); this.bullets.push({x:p.x+15, y:p.y-20});
            p.ammo--; AudioSys.play('shoot');
        }

        // --- UPDATE POSITIONS ---
        this.scenery.forEach(s => {
            s.y += moveDist;
            if(s.crashed) { s.y += 200 * dt; s.x += (s.x < 400 ? -50 : 50) * dt; s.angle += 5 * dt; }
        });
        this.envObjects.forEach(e => e.y += moveDist);

        this.entities.forEach(e => {
            if(e.type === 'missile') { 
                e.y += 15; 
                if(e.targetX) { let diff = e.targetX - e.x; e.x += diff * 2 * dt; } 
            }
            else if (e.type.includes('ped')) { 
                e.y += moveDist; e.x += e.vx * dt; if(e.vy) e.y += e.vy * 50 * dt; 
            }
            else {
                // Car Movement
                let relSpeed = (p.speed - e.speed);
                e.y += relSpeed * 50 * dt;
                e.x += e.vx * dt; e.vx *= 0.9; // Friction applied to lateral impact
                e.x = Math.max(205, Math.min(595, e.x)); // Keep cars on road

                // POLICE AI
                if(e.type === 'police' && this.crimeLevel > 0) {
                      if(e.y < p.y) { // Ahead: Block
                          if(e.x < p.x) e.x += 80 * dt; else e.x -= 80 * dt;
                          e.y += 20 * dt; 
                      } else { // Behind: Ram
                          e.y -= 80 * dt;
                          if(Math.abs(e.y - p.y) < 300) { if(e.x < p.x) e.x += 100 * dt; else e.x -= 100 * dt; } 
                      }
                }
            }
        });

        // --- PHYSICS: ENTITY REPELLANT (Prevent Stacking) ---
        for(let i=0; i<this.entities.length; i++){
            for(let j=i+1; j<this.entities.length; j++){
                let a = this.entities[i];
                let b = this.entities[j];
                if(a.type !== 'missile' && b.type !== 'missile' && !a.type.includes('ped') && !b.type.includes('ped')) {
                    if(Math.abs(a.x - b.x) < 40 && Math.abs(a.y - b.y) < 70) {
                        // Push apart
                        let dx = a.x - b.x;
                        if(dx > 0) { a.x += 2; b.x -= 2; } else { a.x -= 2; b.x += 2; }
                    }
                }
            }
        }

        this.bullets.forEach(b => b.y -= 1000 * dt);
        this.particles.forEach(pt => { pt.x+=pt.vx; pt.y+=pt.vy; pt.life-=2 * dt; });
        this.texts.forEach(t => { t.y -= 50 * dt; t.life -= 1 * dt; });

        // --- COLLISIONS ---
        
        // 1. Scenery Collision (Billboards)
        this.scenery.forEach(s => {
             if(s.type === 'billboard' && !s.crashed) {
                 if(Math.abs(p.x - s.x) < (p.w/2 + s.w/2) && Math.abs(p.y - s.y) < (p.h/2 + 5)) {
                     s.crashed = true;
                     p.hp -= 2;
                     p.speed *= 0.9;
                     AudioSys.play('smash');
                     this.spawnPart(s.x, s.y, '#fff', 10);
                 }
             }
        });

        // 2. Entity Collision
        this.entities.forEach(e => {
            if(e.dead) return;
            if(Math.abs(p.x - e.x) < (p.w/2 + e.w/2) && Math.abs(p.y - e.y) < (p.h/2 + e.h/2)) {
                
                // Bust Logic: Only if REALLY slow AND hitting cop
                if(e.type === 'police' && p.speed < 2) { this.gameOver(true); }

                if(e.type === 'ammo') { e.dead=true; p.ammo+=20; this.spawnText("+AMMO", p.x, p.y-30, '#f1c40f'); AudioSys.play('coin'); }
                else if (e.type === 'bundle') { e.dead=true; this.score += 100; this.spawnText("+$100", p.x, p.y-30, '#2ecc71'); AudioSys.play('coin'); }
                else if (e.type.includes('ped')) {
                    e.dead=true; this.spawnPart(e.x, e.y, 'red', 10);
                    if(e.type==='ped_cop') { this.crimeLevel=2; this.spawnText("POLICE DOWN!", p.x, p.y-30, 'red'); }
                    else { this.crimeLevel=Math.max(1,this.crimeLevel); this.spawnText("CRIME!", p.x, p.y-30, 'orange'); }
                } 
                else if (e.type === 'missile') { p.hp -= 30; e.dead=true; this.spawnPart(p.x,p.y,'orange',30); AudioSys.play('crash'); }
                else {
                    // --- CAR PHYSICS RESOLUTION ---
                    AudioSys.play('crash');
                    this.crimeLevel = Math.max(1, this.crimeLevel);

                    // De-tract logic (Bounce)
                    let dx = p.x - e.x;
                    let dy = p.y - e.y; // not used much for X physics but good for rear-end
                    
                    // Force Multiplier based on mass
                    let force = 400 * (p.mass / (e.mass||1));

                    if(Math.abs(dx) > 10) { 
                        // Lateral Hit (Side Swipe)
                        if(p.x < e.x) { e.vx = force; } else { e.vx = -force; }
                        p.hp -= 2; e.hp -= 5;
                        this.spawnPart((p.x+e.x)/2, (p.y+e.y)/2, '#fff', 5);
                    } else {
                        // Rear End
                        p.speed *= 0.8; // Slow player down
                        e.y -= 50; // Bump forward
                        e.hp -= 15; p.hp -= 5;
                        this.spawnPart((p.x+e.x)/2, (p.y+e.y)/2, '#ccc', 8);
                    }

                    if(e.hp<=0) { e.dead=true; this.spawnPart(e.x,e.y,'orange',20); if(e.type==='police') this.policeKilled++; }
                }
            }
        });

        // Bullet Logic
        this.bullets = this.bullets.filter(b => {
            let hit = false;
            if(this.heli.active && Math.abs(b.x - this.heli.x)<40 && Math.abs(b.y - this.heli.y)<30) {
                this.heli.hp--; hit=true; this.spawnPart(this.heli.x, this.heli.y, '#ccc', 1);
                if(this.heli.hp<=0) { this.heli.active=false; this.score+=1000; this.spawnPart(this.heli.x,this.heli.y,'orange',60); }
            }
            this.entities.forEach(e => {
                if(!hit && !e.dead && ['civ','police'].includes(e.type) && Math.abs(b.x-e.x)<30 && Math.abs(b.y-e.y)<40) {
                    e.hp-=10; hit=true;
                    if(e.hp<=0) { e.dead=true; this.crimeLevel=Math.max(1,this.crimeLevel); if(e.type==='police') this.policeKilled++; this.spawnPart(e.x,e.y,'orange',15); }
                }
            });
            return !hit && b.y > -50;
        });

        // Cleanup
        this.entities = this.entities.filter(e => !e.dead && e.y < 1200 && e.y > -200);
        this.scenery = this.scenery.filter(s => s.y < 1200);
        this.envObjects = this.envObjects.filter(e => e.y < 1200);
        this.particles = this.particles.filter(p => p.life > 0);
        this.texts = this.texts.filter(t => t.life > 0);

        if(p.hp <= 0) this.gameOver(false);
        
        document.getElementById('score-val').innerText = this.score;
        document.getElementById('hp-bar').style.width = Math.max(0,(p.hp/p.maxHp*100))+'%';
        document.getElementById('nitro-bar').style.width = p.nitro+'%';
        document.getElementById('ammo-count').innerText = p.ammo;
    },

    draw() {
        ctx.fillStyle = this.theme.grass; ctx.fillRect(0,0,GW,GH);
        ctx.fillStyle = this.theme.road; ctx.fillRect(200, 0, 400, GH);
        ctx.fillStyle = this.theme.lane;
        for(let i=0; i<800; i+=100) { let y=(i+this.roadOffset)%800-100; ctx.fillRect(395, y, 10, 40); }

        this.envObjects.forEach(e => { if(e.type==='zebra'){ ctx.fillStyle='#fff'; for(let x=210;x<590;x+=40) ctx.fillRect(x,e.y,20,50); }});
        
        // Draw Scenery (Back Layer)
        this.scenery.forEach(s => {
             if(s.type==='build') { ctx.fillStyle='#111'; ctx.fillRect(s.x-30,s.y-80,60,80); ctx.fillStyle='#ff0'; if(Math.random()>0.5) ctx.fillRect(s.x-10,s.y-60,5,10); }
             else if (s.type==='tree') { ctx.fillStyle='#420'; ctx.fillRect(s.x-5,s.y,10,25); ctx.fillStyle='#282'; ctx.beginPath(); ctx.arc(s.x,s.y-10,20,0,Math.PI*2); ctx.fill(); }
             else if (s.type==='billboard') Artist.drawBillboard(ctx, s);
             else { ctx.fillStyle='#555'; ctx.fillRect(s.x-2,s.y-40,4,40); ctx.fillStyle='#ffeda0'; ctx.beginPath(); ctx.arc(s.x,s.y-40,4,0,Math.PI*2); ctx.fill(); }
        });

        this.entities.forEach(e => {
            if(e.type==='bundle') Artist.drawBundle(ctx, e.x, e.y);
            else if(e.type==='ammo') Artist.drawAmmo(ctx, e.x, e.y);
            else if(e.type==='missile') { ctx.fillStyle='#fff'; ctx.fillRect(e.x-5,e.y,10,20); }
            else if(e.type.includes('ped')) Artist.drawPed(ctx, e.x, e.y, e.shirt);
            else Artist.drawCar(ctx, e.x, e.y, e.type, e.color, e.w, e.h, e.hp);
        });

        if(this.heli.active) {
            Artist.drawHeli(ctx, this.heli.x, this.heli.y, this.heli.hp);
            if(this.heli.timer > 2 && this.heli.timer < 3) {
                ctx.strokeStyle='red'; ctx.lineWidth=3; 
                ctx.beginPath(); ctx.moveTo(this.heli.x, this.heli.y); ctx.lineTo(this.player.x, this.player.y); ctx.stroke();
            }
        }

        ctx.fillStyle='#ff0'; this.bullets.forEach(b => ctx.fillRect(b.x,b.y,4,10));
        
        if(Input.up && this.player.nitro > 0) Artist.drawExhaust(ctx, this.player.x, this.player.y, this.player.w);
        Artist.drawCar(ctx, this.player.x, this.player.y, 'racer', this.car.color, 40, 70, this.player.hp);
        
        this.particles.forEach(p => { ctx.globalAlpha=p.life; ctx.fillStyle=p.c; ctx.fillRect(p.x,p.y,4,4); ctx.globalAlpha=1; });
        this.texts.forEach(t => { ctx.globalAlpha=t.life; ctx.fillStyle=t.color; ctx.font='bold 20px Arial'; ctx.fillText(t.str, t.x, t.y); ctx.globalAlpha=1; });
    },

    spawnPart(x, y, c, n) { for(let i=0;i<n;i++) this.particles.push({x,y,vx:(Math.random()-0.5)*10,vy:(Math.random()-0.5)*10,life:1,c}); },

    gameOver(busted) {
        this.state='GAMEOVER'; document.getElementById('wasted-screen').style.display='flex';
        document.getElementById('busted-text').innerText = busted ? "BUSTED" : "WASTED";
        document.getElementById('busted-text').style.background = busted ? "#2980b9" : "#c0392b";
        document.getElementById('final-score').innerText=this.score;
        if(busted) AudioSys.play('busted');
    },

    loop(timestamp) { 
        const dt = (timestamp - this.lastTime) / 1000;
        this.lastTime = timestamp;

        if(this.state==='PLAYING') { 
            try {
                this.update(dt || 0.016); 
                this.draw(); 
            } catch (e) {
                console.log("Recovering from error...", e);
                this.player.x = 400; this.player.speed = 0;
            }
        } 
        requestAnimationFrame(t => this.loop(t)); 
    }
};

Game.init();
</script>
</body>
</html>
